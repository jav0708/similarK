# 相似K线寻找

## 项目概述

这个项目专注于从A股市场历史数据中通过**Ranked KLine（排序K线）算法**来寻找相似的K线模式，并统计不同排序组合的出现频率及其对应的未来收益率。通过对时间窗口内开高收低价格的排序分析，识别具有统计显著性的K线模式。

## 项目目标

- 识别具有预测价值的K线模式
- 统计不同模式对应的未来收益率分布
- 提供可配置的时间窗口和预测周期
- 支持大规模数据批量处理


## 处理模式

本项目支持两种数据处理模式：

### 模式一：批量处理（全市场分析）
- **功能**: 读取指定文件夹中所有股票的历史数据
- **用途**: 进行全市场K线模式的统计分析
- **输出**: 生成包含所有股票数据的综合统计报告
- **适用场景**: 寻找市场普遍存在的K线模式规律

**特点**:
- 处理大量股票数据，样本容量大
- 统计结果更具普遍性和稳定性
- 能发现跨股票的共同模式
- 计算资源需求较高

### 模式二：单股分析（个股专项分析）
- **功能**: 针对指定的单只股票进行深度分析
- **用途**: 分析特定股票的个性化K线模式
- **输出**: 生成该股票专属的模式统计报告
- **适用场景**: 对特定股票进行精准的量化分析

**特点**:
- 专注单只股票，分析更精细
- 能发现个股特有的模式特征
- 计算速度快，资源消耗少
- 适合实时交易决策支持

## 技术栈

- **Python 3.8+**: 核心开发语言
- **pandas**: 数据处理和分析
- **numpy**: 数值计算和排序算法
- **scipy**: 统计检验和科学计算
- **matplotlib**: 数据可视化
- **PyYAML**: 配置文件解析

## 安装和使用

### 安装步骤

1. 克隆项目
```bash
git clone https://github.com/your-username/similar_K.git
cd similar_K
```

2. 创建虚拟环境
```bash
conda create -n similar_K python=3.10
conda activate similar_K
```

3. 安装依赖
```bash
pip install -r requirements.txt
```

### 快速开始

#### 1. 数据准备
将K线数据文件放入 `data_example/` 目录：
- 每个CSV文件包含一只股票的完整历史数据
- 支持中文列名格式（股票代码、股票简称、交易日期、开盘价、最高价、最低价、收盘价等）
- 文件命名格式：`{股票代码}.csv`

#### 2. 单股开盘价分析（推荐入门）
```bash
# 分析单只股票开盘价的10日窗口排序模式
python main.py --mode single --stock_file data_example/sh600082.csv --price_type open -w 10
```

#### 3. 批量分析（市场级别）
```bash
# 分析整个文件夹中所有股票的收盘价模式
python main.py --mode batch --data_dir data_example/ --price_type close -w 20 --parallel 4
```

#### 4. 查看结果
结果将保存在 `output/` 目录下：
- **单股分析**: `output/single_stock/{股票代码}_{价格类型}_w{窗口}.csv`
- **批量分析**: `output/market/market_{价格类型}_w{窗口}.csv`
- **可视化图表**: `output/charts/`目录

## API文档

### 命令行参数

#### 模式一：批量处理（全市场分析）
```bash
python main.py --mode batch --data_dir [数据文件夹路径] [其他参数]
```

#### 模式二：单股分析（个股专项分析）
```bash
python main.py --mode single --stock_file [单个股票文件路径] [其他参数]
```

#### 核心参数

- `--mode`: 处理模式 (batch/single, 必选)
- `--data_dir`: 数据文件夹路径 (batch模式必选)
- `--stock_file`: 单个股票文件路径 (single模式必选)
- `--price_type, -p`: 价格类型 (open/high/low/close, 必选)
- `--window, -w`: 时间窗口长度 (必选)
- `--output_dir, -o`: 输出目录 (默认: output/)


## 使用示例

### 示例1：单股开盘价分析

```bash
# 分析海泰发展开盘价的10日窗口排序模式
python main.py --mode single --stock_file data_example/sh600082.csv --price_type open -w 10 -o results/
```

预期输出：
```
=== 单股K线排序分析 ===
股票: sh600082 (海泰发展)
价格类型: 开盘价
时间窗口: 10
数据范围: 1997-06-20 至 2024-12-31

正在计算开盘价排序模式...
找到排序模式: 3628800 种可能
实际出现模式: 1247 种
高频模式 (≥10次): 89 种

生成分析表格...
保存结果: output/single_stock/sh600082_open_w10.csv
分析完成！
```

### 示例2：单股收盘价分析

```bash
# 分析收盘价的20日窗口
python main.py --mode single --stock_file data_example/sh600082.csv --price_type close -w 20 -o results/
```

将生成文件：`sh600082_close_w20.csv`

### 示例3：批量处理（全市场分析）

```bash
# 批量分析所有股票的最高价排序模式
python main.py --mode batch --data_dir data_example/ --price_type high -w 15 -o market_analysis/
```

将生成文件：`market_high_w15.csv`

## 数据格式说明

### 输入数据格式

#### CSV格式 (中文列名)
本项目支持包含中文列名的A股数据CSV文件格式：

```csv
股票代码,股票简称,交易日期,开盘价,最高价,最低价,收盘价,前收盘价,成交量,成交额,流通市值,总市值
sh600082,海泰发展,1997-06-20,10.2,11.09,9.7,10.9,5.18,20366800.0,211444048.0,327000000.0,1249140000.0
sh600082,海泰发展,1997-06-23,10.85,10.9,9.82,10.1,10.9,8777300.0,90422378.0,303000000.0,1157460000.0
sh600082,海泰发展,1997-06-24,10.07,10.26,9.78,9.9,10.1,4050400.0,40319176.0,297000000.0,1134540000.0
...
```

**必需列**:
- `股票代码`: 股票代码 (如sh600082)
- `股票简称`: 股票名称 (如海泰发展)
- `交易日期`: 交易日期 (YYYY-MM-DD 格式)
- `开盘价`: 开盘价
- `最高价`: 最高价
- `最低价`: 最低价
- `收盘价`: 收盘价
- `前收盘价`: 前一交易日收盘价

**可选列**:
- `成交量`: 成交量 (手)
- `成交额`: 成交金额 (元)
- `流通市值`: 流通市值 (元)
- `总市值`: 总市值 (元)

**文件组织方式**:
- 每个CSV文件包含一只股票的完整历史数据
- 文件命名格式：`{股票代码}.csv` (如：sh600082.csv)
- 数据按交易日期正序排列
- 支持批量处理整个数据文件夹

### 输出结果格式

#### 分析表格结构（CSV格式）

每个分析结果表格包含以下12列：

```csv
rank_pattern,return_1d_mean,return_1d_std,return_3d_mean,return_3d_std,return_5d_mean,return_5d_std,return_10d_mean,return_10d_std,return_20d_mean,return_20d_std,frequency
"[1,2,3,4,5,6,7,8,9,10]",0.0125,0.0234,0.0287,0.0456,0.0398,0.0567,0.0512,0.0723,0.0689,0.0891,156
"[2,4,1,5,3,7,6,9,8,10]",0.0089,0.0198,0.0201,0.0334,0.0276,0.0445,0.0387,0.0598,0.0534,0.0756,98
"[10,9,8,7,6,5,4,3,2,1]",-0.0156,0.0289,-0.0234,0.0423,-0.0298,0.0534,-0.0387,0.0678,-0.0445,0.0823,89
...
```

**列定义**:
1. `rank_pattern`: 排序模式列表（第1列）
2. `return_1d_mean`: 未来1天平均收益率（第2列）
3. `return_1d_std`: 未来1天收益率标准差（第3列）
4. `return_3d_mean`: 未来3天平均收益率（第4列）
5. `return_3d_std`: 未来3天收益率标准差（第5列）
6. `return_5d_mean`: 未来5天平均收益率（第6列）
7. `return_5d_std`: 未来5天收益率标准差（第7列）
8. `return_10d_mean`: 未来10天平均收益率（第8列）
9. `return_10d_std`: 未来10天收益率标准差（第9列）
10. `return_20d_mean`: 未来20天平均收益率（第10列）
11. `return_20d_std`: 未来20天收益率标准差（第11列）
12. `frequency`: 该排序模式出现次数（第12列）

#### 文件命名规则

**单股分析**:
- `{股票代码}_{价格类型}_w{窗口长度}.csv`
- 示例：`sh600082_open_w10.csv`、`sh600082_close_w20.csv`

**批量分析**:
- `market_{价格类型}_w{窗口长度}.csv`
- 示例：`market_high_w15.csv`、`market_low_w30.csv`

#### 输出文件夹结构
```
output/
├── single_stock/           # 单股分析结果
│   ├── sh600082_open_w10.csv
│   ├── sh600082_open_w20.csv
│   ├── sh600082_high_w10.csv
│   └── ...
├── market/                 # 批量分析结果
│   ├── market_open_w10.csv
│   ├── market_close_w20.csv
│   └── ...
└── charts/                 # 可视化图表
    ├── frequency_distribution.png
    └── return_analysis.png
```


